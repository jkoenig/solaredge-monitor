---
phase: 04-display-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rendering/__init__.py
  - rendering/fonts.py
  - rendering/icons.py
  - rendering/bars.py
autonomous: true

must_haves:
  truths:
    - "Fonts load from project fonts/ directory with fallback to system fonts and PIL default"
    - "Font objects are cached so repeated calls return the same instance without file I/O"
    - "Four geometric icons render correctly: battery rectangle, house outline, grid lines, sun with rays"
    - "Horizontal bars render with filled portion proportional to percentage and percentage text"
  artifacts:
    - path: "rendering/__init__.py"
      provides: "Package init exporting public API"
      contains: "from rendering.fonts import"
    - path: "rendering/fonts.py"
      provides: "Font loading with caching and fallback chain"
      exports: ["load_font"]
    - path: "rendering/icons.py"
      provides: "Geometric icon drawing functions for battery, house, grid, sun"
      exports: ["draw_battery_icon", "draw_house_icon", "draw_grid_icon", "draw_sun_icon"]
    - path: "rendering/bars.py"
      provides: "Horizontal bar chart drawing with percentage display"
      exports: ["draw_horizontal_bar"]
  key_links:
    - from: "rendering/bars.py"
      to: "rendering/fonts.py"
      via: "import for percentage text rendering"
      pattern: "from rendering\\.fonts import load_font"
    - from: "rendering/icons.py"
      to: "PIL.ImageDraw"
      via: "drawing primitives (rectangle, ellipse, polygon, line)"
      pattern: "draw\\.(rectangle|ellipse|polygon|line)"
---

<objective>
Create the shared rendering utilities module with font loading, geometric icon drawing, and horizontal bar chart functions.

Purpose: These are the building blocks that all 4 screen renderers will use. Fonts, icons, and bars must exist before screens can be built.
Output: rendering/ package with fonts.py, icons.py, bars.py ready for import by screen renderers.
</objective>

<execution_context>
@/Users/jean-pierrekoenig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jean-pierrekoenig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-layer/04-CONTEXT.md
@.planning/phases/04-display-layer/04-RESEARCH.md
@models.py
@display.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create font loading module with caching and fallback</name>
  <files>rendering/__init__.py, rendering/fonts.py</files>
  <action>
Create the rendering/ package directory and two files:

**rendering/__init__.py:**
Export public API from submodules:
- `from rendering.fonts import load_font`
- `from rendering.icons import draw_battery_icon, draw_house_icon, draw_grid_icon, draw_sun_icon`
- `from rendering.bars import draw_horizontal_bar`

**rendering/fonts.py:**
Implement `load_font(font_name: str, size: int) -> ImageFont.FreeTypeFont` with:

1. Module-level `_FONT_CACHE: dict = {}` for caching by `(font_name, size)` tuple key
2. Return cached font if cache hit
3. Fallback search chain for font files:
   - `Path("fonts") / font_name` (project-local fonts directory — Arial.ttf and ArialBlack.ttf are already there)
   - `Path("/usr/share/fonts/truetype/dejavu") / font_name` (Raspberry Pi system fonts)
   - `Path("/usr/share/fonts/truetype/liberation") / font_name` (alternate system fonts)
4. If no font file found, log a warning and return `ImageFont.load_default()`
5. Cache the loaded font before returning

Use `from pathlib import Path` for path operations.
Use `from PIL import ImageFont`.
Add a module docstring explaining the caching behavior and search order.

Important: Do NOT use `ImageFont.load_default(size=N)` — that API does not exist in Pillow 10.x. Use `ImageFont.load_default()` with no arguments as the final fallback.
  </action>
  <verify>
Run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "from rendering.fonts import load_font; f = load_font('Arial.ttf', 96); print(type(f)); f2 = load_font('Arial.ttf', 96); print(f is f2)"`
Expected: Shows FreeTypeFont type and True (cache hit returns same object).
  </verify>
  <done>load_font() loads Arial.ttf from project fonts/ directory, caches results, and returns PIL font objects. Module imports cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create icon drawing and horizontal bar modules</name>
  <files>rendering/icons.py, rendering/bars.py</files>
  <action>
**rendering/icons.py:**
Implement 4 icon drawing functions, each taking `(draw: ImageDraw.Draw, x: int, y: int, size: int)`:

1. `draw_battery_icon`: Rectangle body with small terminal rectangle on top. Use `draw.rectangle()` with `outline=0, width=6` for body, `fill=0` for terminal.

2. `draw_house_icon`: Triangle roof using `draw.polygon()` with 3 points (top center, bottom-left, bottom-right) + rectangle body below using `draw.rectangle()`. Use `outline=0, width=6`.

3. `draw_grid_icon`: Grid pattern of 4 vertical + 4 horizontal lines using `draw.line()` evenly spaced within the size bounding box. Use `fill=0, width=4`.

4. `draw_sun_icon`: Filled circle center using `draw.ellipse()` with `fill=0`, plus 8 rays at 0/45/90/135/180/225/270/315 degrees using `draw.line()`. Use `import math` for trig. Ray width=6.

All icons render in black (fill=0) on white (1) background. All coordinates relative to (x, y) origin within a square bounding box of `size` pixels. These are at 4x supersampled resolution (so size ~60-80 for ~15-20px display size).

**rendering/bars.py:**
Implement `draw_horizontal_bar(draw: ImageDraw.Draw, bbox: tuple, percentage: float, font)`:

Parameters:
- `draw`: ImageDraw instance
- `bbox`: Tuple of (x0, y0, x1, y1) defining bar bounds
- `percentage`: 0-100 fill percentage
- `font`: PIL font object for percentage text (caller provides, avoids circular import issues)

Implementation:
1. Draw outline rectangle with `outline=0, width=4`
2. Clamp percentage to 0-100
3. Calculate fill_width as `int((percentage / 100.0) * (x1 - x0))`
4. Draw filled rectangle from x0 to x0+fill_width if fill_width > 0
5. Draw percentage text (e.g. "73%") centered vertically in the bar, positioned to the RIGHT of the bar (at x1 + 15) in black (fill=0). This avoids the complexity of white-on-black text within the filled portion.

Use `draw.textbbox()` to measure text for vertical centering.

Important: Do NOT import from rendering.fonts inside bars.py. The font is passed as a parameter to avoid circular imports and keep the function pure.
  </action>
  <verify>
Run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "
from PIL import Image, ImageDraw
from rendering.icons import draw_battery_icon, draw_house_icon, draw_grid_icon, draw_sun_icon
from rendering.bars import draw_horizontal_bar
from rendering.fonts import load_font
img = Image.new('1', (400, 400), 1)
draw = ImageDraw.Draw(img)
draw_battery_icon(draw, 10, 10, 80)
draw_house_icon(draw, 110, 10, 80)
draw_grid_icon(draw, 210, 10, 80)
draw_sun_icon(draw, 310, 10, 80)
font = load_font('Arial.ttf', 36)
draw_horizontal_bar(draw, (10, 150, 350, 190), 73.0, font)
img.save('debug/rendering_test.png')
print('Rendering test saved to debug/rendering_test.png')
"`
Expected: No errors, PNG file created with 4 icons and a bar.
  </verify>
  <done>Four icon functions and horizontal bar function render correctly to PIL images. All functions accept standard PIL ImageDraw and produce visible black shapes on white background.</done>
</task>

</tasks>

<verification>
1. `python3 -c "from rendering import load_font, draw_battery_icon, draw_house_icon, draw_grid_icon, draw_sun_icon, draw_horizontal_bar; print('All rendering exports available')"` succeeds
2. `debug/rendering_test.png` exists and shows 4 distinct icons + a filled bar
3. Font caching works (same font_name+size returns identical object)
</verification>

<success_criteria>
- rendering/ package exists with fonts.py, icons.py, bars.py
- All functions importable from rendering package
- Font loading finds Arial.ttf from project fonts/ directory
- Icons produce visible geometric shapes
- Bar chart fills proportionally to percentage value
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-layer/04-01-SUMMARY.md`
</output>
