---
phase: 04-display-layer
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - screens/__init__.py
  - screens/production.py
  - screens/consumption.py
  - screens/feed_in.py
  - screens/purchased.py
autonomous: true

must_haves:
  truths:
    - "Produktion screen shows large kWh value, horizontal bar, and 3-item breakdown (Eigenverbrauch, Batterie, Netz) with icons"
    - "Verbrauch screen shows large kWh value, horizontal bar, and 3-item breakdown (Solar, Batterie, Netz) with icons"
    - "Einspeisung screen uses full display for feed-in kWh value and horizontal bar"
    - "Bezug screen uses full display for purchased kWh value and horizontal bar"
    - "All screens return 1000x488 PIL Images in mode '1' (1-bit monochrome)"
    - "All labels are in German"
  artifacts:
    - path: "screens/__init__.py"
      provides: "Package init with SCREENS list and screen function exports"
      contains: "SCREENS"
    - path: "screens/production.py"
      provides: "Produktion screen renderer"
      exports: ["render_production_screen"]
    - path: "screens/consumption.py"
      provides: "Verbrauch screen renderer"
      exports: ["render_consumption_screen"]
    - path: "screens/feed_in.py"
      provides: "Einspeisung screen renderer"
      exports: ["render_feed_in_screen"]
    - path: "screens/purchased.py"
      provides: "Bezug screen renderer"
      exports: ["render_purchased_screen"]
  key_links:
    - from: "screens/production.py"
      to: "rendering"
      via: "import for fonts, icons, bars"
      pattern: "from rendering import"
    - from: "screens/production.py"
      to: "models.EnergyDetails"
      via: "type annotation on data parameter"
      pattern: "data: EnergyDetails"
    - from: "screens/__init__.py"
      to: "screens/*.py"
      via: "SCREENS list of render functions"
      pattern: "SCREENS.*=.*\\["
---

<objective>
Create 4 screen renderer functions that transform EnergyDetails data into 1000x488 monochrome PIL Images ready for e-ink display.

Purpose: These are the core visual output of the monitor. Each screen shows one aspect of solar energy data (production, consumption, feed-in, purchased) with German labels, large readable kWh values, horizontal bars, and icon-based breakdowns.
Output: screens/ package with 4 renderer functions and a SCREENS registry list for cycling.
</objective>

<execution_context>
@/Users/jean-pierrekoenig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jean-pierrekoenig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-layer/04-CONTEXT.md
@.planning/phases/04-display-layer/04-RESEARCH.md
@models.py
@rendering/fonts.py
@rendering/icons.py
@rendering/bars.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create complex screens (Produktion and Verbrauch) with breakdown rows</name>
  <files>screens/__init__.py, screens/production.py, screens/consumption.py</files>
  <action>
Create the screens/ package directory and three files:

**screens/__init__.py:**
```python
from screens.production import render_production_screen
from screens.consumption import render_consumption_screen
from screens.feed_in import render_feed_in_screen
from screens.purchased import render_purchased_screen

# Screen registry for cycling (Phase 5 polling loop uses this)
SCREENS = [
    render_production_screen,
    render_consumption_screen,
    render_feed_in_screen,
    render_purchased_screen,
]
```

Note: feed_in and purchased imports will fail until Task 2 creates them. That's OK — Task 2 runs immediately after.

**screens/production.py — render_production_screen(data: EnergyDetails) -> Image:**

Layout (all at 1000x488 supersampled resolution, German labels):

Top section (~60% of height):
- "Produktion" label in smaller font (~56px) at top-left
- Main kWh value as large as possible (~120-140px bold) below the label
- "kWh" unit text in smaller font (~48px) to the right of the value, baseline-aligned
- Horizontal bar below the value showing percentage (production / 20.0 * 100, capped at 100%). 20 kWh = assumed daily max. Bar spans most of the width.

Bottom section (~40% of height) — 3-column breakdown row:
- Column 1: House icon + "Eigenverbrauch" label below + self_consumption kWh value
- Column 2: Battery icon + "Batterie" label below + (production - self_consumption - feed_in) kWh value (energy that went to battery = production minus what was self-consumed minus what was fed in; clamp to 0 if negative)
- Column 3: Grid icon + "Netz" label below + feed_in kWh value

Each breakdown column: icon centered at top (~60px size), short label below in small font (~36px), kWh value below label in medium font (~44px). Evenly spaced across width.

Use:
- `from PIL import Image, ImageDraw`
- `from models import EnergyDetails`
- `from rendering.fonts import load_font`
- `from rendering.icons import draw_house_icon, draw_battery_icon, draw_grid_icon`
- `from rendering.bars import draw_horizontal_bar`

Create image with `Image.new('1', (1000, 488), 1)` — mode '1' for 1-bit, white background (1).
Use `draw.textbbox()` to measure text width before positioning for proper alignment.
Font choices: Use 'Arial.ttf' for labels and units, 'ArialBlack.ttf' for large values (bolder = more readable).

**screens/consumption.py — render_consumption_screen(data: EnergyDetails) -> Image:**

Same layout structure as production but with different data mapping:
- "Verbrauch" label
- Main value: data.consumption kWh
- Bar: consumption / 15.0 * 100 (assumed 15 kWh daily consumption max)
- Breakdown row shows where consumption came FROM:
  - Column 1: Sun icon + "Solar" label + self_consumption kWh
  - Column 2: Battery icon + "Batterie" label + (consumption - self_consumption - purchased) kWh (from battery; clamp to 0)
  - Column 3: Grid icon + "Netz" label + purchased kWh

Same font sizes, spacing, and icon sizes as production screen for visual consistency.
  </action>
  <verify>
Run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "
from PIL import Image
from models import EnergyDetails
from screens.production import render_production_screen
from screens.consumption import render_consumption_screen
data = EnergyDetails(production=12.5, self_consumption=8.3, feed_in=3.1, consumption=10.2, purchased=1.9)
img1 = render_production_screen(data)
print(f'Production: mode={img1.mode}, size={img1.size}')
img1.save('debug/screen_production.png')
img2 = render_consumption_screen(data)
print(f'Consumption: mode={img2.mode}, size={img2.size}')
img2.save('debug/screen_consumption.png')
print('Both screens saved to debug/')
"`
Expected: Both return mode='1', size=(1000, 488). PNGs saved showing layout with German labels.
  </verify>
  <done>Production and consumption screens render with large kWh values, bars, German labels, and 3-column icon breakdowns. Both return 1000x488 1-bit PIL Images.</done>
</task>

<task type="auto">
  <name>Task 2: Create simple screens (Einspeisung and Bezug) — full-screen single metrics</name>
  <files>screens/feed_in.py, screens/purchased.py</files>
  <action>
**screens/feed_in.py — render_feed_in_screen(data: EnergyDetails) -> Image:**

Full-screen layout for a single metric (all 1000x488 space for one value):
- "Einspeisung" label in medium font (~64px) centered or left-aligned near top
- Main kWh value as LARGE AS POSSIBLE (~160-180px bold) — this screen has no breakdown row so the value can be much bigger than on Produktion/Verbrauch
- "kWh" unit text (~56px) to the right of the value
- Horizontal bar below spanning most of width, percentage = feed_in / 10.0 * 100 (10 kWh daily feed-in max, capped at 100%)
- Use remaining vertical space generously — center the content vertically for balance

**screens/purchased.py — render_purchased_screen(data: EnergyDetails) -> Image:**

Same full-screen layout as feed_in but for grid purchase:
- "Bezug" label
- Main value: data.purchased kWh (extra large, same size as feed_in)
- "kWh" unit
- Horizontal bar: purchased / 10.0 * 100 (10 kWh daily purchase max)

Both screens use the same fonts and sizing for visual consistency with each other. Values should be noticeably larger than on the complex screens since there's more space.

Use same imports pattern:
- `from PIL import Image, ImageDraw`
- `from models import EnergyDetails`
- `from rendering.fonts import load_font`
- `from rendering.bars import draw_horizontal_bar`

Create image with `Image.new('1', (1000, 488), 1)`.
  </action>
  <verify>
Run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "
from PIL import Image
from models import EnergyDetails
from screens.feed_in import render_feed_in_screen
from screens.purchased import render_purchased_screen
from screens import SCREENS
data = EnergyDetails(production=12.5, self_consumption=8.3, feed_in=3.1, consumption=10.2, purchased=1.9)
img3 = render_feed_in_screen(data)
print(f'Feed-in: mode={img3.mode}, size={img3.size}')
img3.save('debug/screen_feed_in.png')
img4 = render_purchased_screen(data)
print(f'Purchased: mode={img4.mode}, size={img4.size}')
img4.save('debug/screen_purchased.png')
print(f'SCREENS registry has {len(SCREENS)} screens')
print('All screens saved to debug/')
"`
Expected: Both return mode='1', size=(1000, 488). SCREENS has 4 entries. PNGs saved.
  </verify>
  <done>Feed-in and purchased screens render full-screen with extra-large kWh values. SCREENS registry in __init__.py has all 4 render functions.</done>
</task>

</tasks>

<verification>
1. `python3 -c "from screens import SCREENS; print(len(SCREENS))"` prints 4
2. All 4 debug PNGs exist (screen_production.png, screen_consumption.png, screen_feed_in.png, screen_purchased.png)
3. All images are mode='1', size=(1000, 488)
4. All screens show German labels (Produktion, Verbrauch, Einspeisung, Bezug)
5. Complex screens have 3-column breakdown with icons; simple screens have larger values
</verification>

<success_criteria>
- 4 screen renderer functions exist, each accepting EnergyDetails and returning 1000x488 1-bit Image
- SCREENS list in screens/__init__.py contains all 4 functions in order
- German labels used throughout (Produktion, Verbrauch, Einspeisung, Bezug, Eigenverbrauch, Batterie, Netz, Solar)
- kWh values render large and readable
- Horizontal bars show proportional fill
- Complex screens (1, 2) have icon breakdown rows
- Simple screens (3, 4) use full display for single metric
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-layer/04-02-SUMMARY.md`
</output>
