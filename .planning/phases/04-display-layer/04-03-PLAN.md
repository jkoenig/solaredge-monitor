---
phase: 04-display-layer
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - display.py
  - requirements.txt
autonomous: false

must_haves:
  truths:
    - "Display.render() downsamples 1000x488 images to 250x122 using LANCZOS resampling (not nearest-neighbor)"
    - "Pillow is listed as a dependency in requirements.txt"
    - "Running main.py in debug mode generates 4 PNG files in debug/ showing all screens with real-looking data"
    - "PNG output files are at 1000x488 resolution (high-res for visual inspection)"
    - "User has visually verified the 4 screen layouts look correct"
  artifacts:
    - path: "display.py"
      provides: "Updated render() with LANCZOS downsampling via L-mode intermediate"
      contains: "LANCZOS"
    - path: "requirements.txt"
      provides: "Pillow dependency added"
      contains: "Pillow"
  key_links:
    - from: "display.py"
      to: "PIL.Image"
      via: "LANCZOS resampling in render method"
      pattern: "Image\\.LANCZOS"
    - from: "display.py"
      to: "convert"
      via: "1-bit to L mode conversion for quality downsampling"
      pattern: "\\.convert\\("
---

<objective>
Update the Display class with proper LANCZOS downsampling, add Pillow to dependencies, and verify all 4 screens render correctly via debug PNG output.

Purpose: The Display stub from Phase 3 uses basic resize without quality filtering. LANCZOS resampling is critical for readable text on the tiny 250x122 e-ink display. This plan also adds the Pillow dependency and provides a visual checkpoint for the user to verify screen layouts.
Output: Updated display.py with production-quality rendering, Pillow in requirements.txt, and user-verified screen PNGs.
</objective>

<execution_context>
@/Users/jean-pierrekoenig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jean-pierrekoenig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-layer/04-CONTEXT.md
@.planning/phases/04-display-layer/04-RESEARCH.md
@display.py
@requirements.txt
@models.py
@screens/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update display.py with LANCZOS downsampling and add Pillow dependency</name>
  <files>display.py, requirements.txt</files>
  <action>
**display.py updates:**

1. Add `from PIL import Image` at the top of the file (after existing imports).

2. Update the `render()` method to use proper LANCZOS downsampling:
   - For e-ink backend: Convert the 1-bit image to 'L' (grayscale) mode, resize to (250, 122) with `Image.LANCZOS`, then convert back to '1' mode before sending to the display driver. This gives high-quality antialiased downsampling.
   - For PNG backend: Save the high-res (1000x488) image directly (for visual inspection during development). Do NOT downscale PNG output — developers want to see the full detail.
   - Log the screen name in both backends for debugging.

3. The e-ink render path becomes:
```python
# High-quality downsampling: 1-bit -> grayscale -> resize -> 1-bit
gray = image.convert('L')
scaled = gray.resize((self.width, self.height), Image.LANCZOS)
final = scaled.convert('1')
self.epd.display(self.epd.getbuffer(final))
```

4. Keep all existing methods (clear, sleep, __del__) unchanged.

**requirements.txt update:**

Add Pillow with Python 3.9-compatible version constraint:
```
Pillow>=10.0.0,<11.0.0
```
Add after existing entries. Keep python-dotenv and requests lines unchanged.

Then run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && pip install Pillow>=10.0.0,<11.0.0` to ensure Pillow is installed in the local environment.

Also create a small test script and run it to generate all 4 screen PNGs:

```python
# Generate all 4 screens with sample data for visual review
from models import EnergyDetails
from screens import SCREENS
from display import Display

display = Display(debug_mode=True)
data = EnergyDetails(
    production=14.7,
    self_consumption=9.2,
    feed_in=4.1,
    consumption=11.8,
    purchased=2.6
)

screen_names = ["produktion", "verbrauch", "einspeisung", "bezug"]
for renderer, name in zip(SCREENS, screen_names):
    image = renderer(data)
    display.render(image, name=name)
    print(f"Rendered {name}")

print("All 4 screens saved to debug/ folder")
```

Run this script to produce the 4 PNGs, then delete the script file (it was just for testing).
  </action>
  <verify>
1. `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "from display import Display; d = Display(debug_mode=True); print(d.backend)"` prints "png"
2. `python3 -c "from PIL import Image; print(Image.LANCZOS)"` does not error
3. 4 PNG files exist in debug/ folder (produktion_*.png, verbrauch_*.png, einspeisung_*.png, bezug_*.png)
4. `grep Pillow requirements.txt` shows the Pillow line
  </verify>
  <done>Display.render() uses LANCZOS downsampling for e-ink, saves high-res PNGs for debug. Pillow is in requirements.txt. 4 screen PNGs generated in debug/ folder.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All 4 e-ink display screens rendered as PNG files in the debug/ folder. Each shows solar energy data with German labels, large kWh values, horizontal bars, and icon-based breakdowns.</what-built>
  <how-to-verify>
1. Open the 4 PNG files in the debug/ folder:
   - produktion_*.png — Should show "Produktion" label, "14.7" kWh large value, horizontal bar, and 3 breakdown items with icons (Eigenverbrauch 9.2, Batterie ~1.4, Netz 4.1)
   - verbrauch_*.png — Should show "Verbrauch" label, "11.8" kWh large value, horizontal bar, and 3 breakdown items (Solar 9.2, Batterie ~0.0, Netz 2.6)
   - einspeisung_*.png — Should show "Einspeisung" label, "4.1" kWh extra-large value, horizontal bar (full screen layout, no breakdown)
   - bezug_*.png — Should show "Bezug" label, "2.6" kWh extra-large value, horizontal bar (full screen layout, no breakdown)

2. Check readability: kWh values should be the dominant visual element on each screen. They should be readable from 2-3 meters when mentally scaled down to 250x122 pixels.

3. Check layout: No text should overlap. Icons should be recognizable geometric shapes. Bars should be proportionally filled.

4. Check German labels: All text should use German terms (Produktion, Verbrauch, Einspeisung, Bezug, Eigenverbrauch, Batterie, Netz, Solar).
  </how-to-verify>
  <resume-signal>Type "approved" if screens look good, or describe any layout/readability issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. display.py contains `Image.LANCZOS` in the render method
2. requirements.txt contains `Pillow>=10.0.0,<11.0.0`
3. All 4 screen PNGs render without errors
4. PNGs visually show correct layouts (verified by user)
5. `python3 -c "from screens import SCREENS; from display import Display; print(f'{len(SCREENS)} screens, Display OK')"` prints "4 screens, Display OK"
</verification>

<success_criteria>
- LANCZOS downsampling implemented in display.py for e-ink backend
- Pillow added to requirements.txt with Python 3.9 compatible version
- All 4 screens generate PNGs without errors
- User approves visual layout and readability of all 4 screens
- No text overlap, icons recognizable, bars proportionally filled
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-layer/04-03-SUMMARY.md`
</output>
