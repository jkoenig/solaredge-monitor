---
phase: 02-configuration-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.py
  - .env.example
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Application loads all credentials from environment variables or .env file with zero hardcoded values"
    - "Application validates all config at startup and exits with clear, complete error list if required values are missing or invalid"
    - "Application logs loaded config at startup with secrets masked (last 4 chars only)"
    - ".env.example documents all environment variables with descriptions and grouped sections"
    - ".gitignore excludes .env files (already verified from Phase 1)"
  artifacts:
    - path: "config.py"
      provides: "Config dataclass with env loading, validation, type conversion, secret masking"
      contains: "class Config"
      min_lines: 60
    - path: ".env.example"
      provides: "Documented template for all SOLAREDGE_ environment variables"
      contains: "SOLAREDGE_API_KEY"
    - path: "requirements.txt"
      provides: "Pinned python-dotenv dependency"
      contains: "python-dotenv"
  key_links:
    - from: "config.py"
      to: "os.environ"
      via: "os.environ.get() calls in __post_init__"
      pattern: "os\\.environ\\.get\\(\"SOLAREDGE_"
    - from: "config.py"
      to: "python-dotenv"
      via: "load_dotenv import for callers"
      pattern: "from dotenv import load_dotenv|import dotenv"
    - from: ".env.example"
      to: "config.py"
      via: "Variable names match Config field loading"
      pattern: "SOLAREDGE_API_KEY|SOLAREDGE_SITE_ID|SOLAREDGE_POLL_INTERVAL|SOLAREDGE_SLEEP_START|SOLAREDGE_SLEEP_END|SOLAREDGE_DEBUG"
---

<objective>
Create the configuration foundation: a Config dataclass that loads all settings from environment variables with startup validation, a documented .env.example template, and a requirements.txt with pinned python-dotenv.

Purpose: Replace all hardcoded credentials and configuration in se-overview.py with environment-based configuration. This is the foundation that all later phases (API clients, display, operations) will depend on for their settings.

Output: config.py (Config dataclass), .env.example (template), requirements.txt (dependencies)
</objective>

<execution_context>
@/Users/jean-pierrekoenig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jean-pierrekoenig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configuration-foundation/02-CONTEXT.md
@.planning/phases/02-configuration-foundation/02-RESEARCH.md
@se-overview.py
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Config dataclass with environment loading and validation</name>
  <files>config.py, requirements.txt</files>
  <action>
Create `config.py` at the project root (not in a src/ directory -- this project has all Python at root level alongside se-overview.py).

The Config dataclass must implement these locked decisions from CONTEXT.md:

1. **Single Config dataclass** with all settings in one place
2. **SOLAREDGE_ prefix** for all environment variables
3. **Required fields** (no defaults, must be provided):
   - `api_key: str` loaded from `SOLAREDGE_API_KEY`
   - `site_id: str` loaded from `SOLAREDGE_SITE_ID`
4. **Optional fields with defaults**:
   - `poll_interval: int = 5` from `SOLAREDGE_POLL_INTERVAL` (minutes between API polls)
   - `sleep_start_hour: int = 0` from `SOLAREDGE_SLEEP_START` (0-23)
   - `sleep_end_hour: int = 6` from `SOLAREDGE_SLEEP_END` (0-23)
   - `debug: bool = False` from `SOLAREDGE_DEBUG` (true/false)
5. **`__post_init__` method** that:
   - Reads all values from `os.environ.get("SOLAREDGE_*")`
   - Accumulates ALL validation errors in a list before raising
   - Validates required fields are non-empty
   - Converts integers with try/except (catch ValueError), validates ranges (poll >= 1, hours 0-23)
   - Parses booleans safely: `value.lower() in ("true", "1", "yes", "on")` -- NEVER use `bool()` on strings
   - If any errors accumulated, raises `ValueError` with structured message:
     ```
     ERROR: Configuration validation failed:
       - SOLAREDGE_API_KEY: SolarEdge API key (required)
       - SOLAREDGE_POLL_INTERVAL: Must be an integer (got 'abc')
     ```
6. **`log_startup` method** that logs all config values with secrets masked:
   - API key: `****{last_4_chars}` (or `****` if shorter than 4 chars)
   - Site ID: shown in full (not a secret)
   - All other fields: shown as-is
   - Use `logging.info()` for each line

Also create `requirements.txt` at project root with:
```
python-dotenv==1.2.1
```

IMPORTANT: The Config class reads from os.environ in __post_init__, NOT in __init__ parameters. Callers do `config = Config()` with no arguments. The dataclass field defaults exist only for type hinting -- all real values come from environment.

IMPORTANT: Do NOT call load_dotenv() inside config.py. The caller (main entry point) is responsible for calling load_dotenv() before constructing Config(). This follows the research recommendation (Pattern 1: Early Load).

IMPORTANT: Include a module-level docstring explaining usage:
```python
# Usage:
# from dotenv import load_dotenv
# load_dotenv()
# from config import Config
# config = Config()  # loads from environment, validates, raises ValueError on errors
# config.log_startup()  # logs with secrets masked
```
  </action>
  <verify>
Run these checks:

1. `python -c "import config; print('import ok')"` -- module imports without error
2. `python -c "from config import Config; print(Config.__dataclass_fields__.keys())"` -- shows all field names
3. Test validation catches missing required fields:
   ```
   python -c "
   import os
   os.environ.pop('SOLAREDGE_API_KEY', None)
   os.environ.pop('SOLAREDGE_SITE_ID', None)
   from config import Config
   try:
       c = Config()
       print('FAIL: should have raised')
   except ValueError as e:
       print('PASS:', str(e))
   "
   ```
   Expected: ValueError mentioning both SOLAREDGE_API_KEY and SOLAREDGE_SITE_ID
4. Test successful loading with valid env vars:
   ```
   SOLAREDGE_API_KEY=testkey123 SOLAREDGE_SITE_ID=site456 python -c "
   from config import Config
   c = Config()
   print(f'api_key={c.api_key}, site_id={c.site_id}, poll={c.poll_interval}, debug={c.debug}')
   "
   ```
   Expected: api_key=testkey123, site_id=site456, poll=5, debug=False
5. Test boolean truthiness trap is avoided:
   ```
   SOLAREDGE_API_KEY=test SOLAREDGE_SITE_ID=test SOLAREDGE_DEBUG=false python -c "
   from config import Config
   c = Config()
   print(f'debug={c.debug}')
   assert c.debug == False, 'Boolean parsing broken!'
   print('PASS: boolean false handled correctly')
   "
   ```
6. `cat requirements.txt` shows `python-dotenv==1.2.1`
  </verify>
  <done>
config.py exists with Config dataclass that: loads all 6 fields from SOLAREDGE_* env vars, validates required fields, converts types safely, parses booleans correctly (false stays False), accumulates all errors before raising, and has log_startup method with secret masking. requirements.txt exists with pinned python-dotenv.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .env.example and verify end-to-end configuration flow</name>
  <files>.env.example</files>
  <action>
Create `.env.example` at project root with these locked decisions from CONTEXT.md:

1. **Grouped with comment sections**: `# SolarEdge API`, `# Display Settings`, `# Operations`
2. **All SOLAREDGE_ prefixed variables** with descriptions and valid values
3. **Placeholder values** for required fields (not real credentials)
4. **Default values shown** for optional fields

Content:
```
# ===========================================
# SolarEdge Off-Grid Monitor Configuration
# ===========================================
# Copy this file to .env and fill in your values:
#   cp .env.example .env
#
# Required values have no default — app will not start without them.
# Optional values show their defaults — delete or modify as needed.

# -------------------------------------------
# SolarEdge API (required)
# -------------------------------------------
SOLAREDGE_API_KEY=your_api_key_here
SOLAREDGE_SITE_ID=your_site_id_here

# -------------------------------------------
# Display Settings
# -------------------------------------------
# (reserved for Phase 4 — display configuration)

# -------------------------------------------
# Operations
# -------------------------------------------
SOLAREDGE_POLL_INTERVAL=5        # Minutes between API polls (default: 5, minimum: 1)
SOLAREDGE_SLEEP_START=0          # Hour to pause polling, 0-23 (default: 0 = midnight)
SOLAREDGE_SLEEP_END=6            # Hour to resume polling, 0-23 (default: 6 = 6 AM)
SOLAREDGE_DEBUG=false            # Enable debug mode: true/false (default: false)
```

Then verify the end-to-end flow works:

1. Install python-dotenv: `pip install python-dotenv==1.2.1`
2. Create a temporary .env file from .env.example with real-looking test values
3. Test the full load_dotenv -> Config() -> log_startup() pipeline:
   ```python
   from dotenv import load_dotenv
   load_dotenv()
   from config import Config
   config = Config()
   config.log_startup()
   ```
4. Verify .gitignore already excludes .env files (it does from Phase 1: `.env`, `.env.*`, `!.env.example`)
5. Clean up the temporary .env file after testing

Also verify that `git status` shows .env.example as untracked (ready to commit) and NOT .env (gitignored).
  </action>
  <verify>
1. `.env.example` exists and contains all 6 SOLAREDGE_* variables
2. `.env.example` has grouped comment sections (SolarEdge API, Display Settings, Operations)
3. End-to-end test passes:
   ```
   echo 'SOLAREDGE_API_KEY=testapikey1234\nSOLAREDGE_SITE_ID=testsite567' > /tmp/test.env
   DOTENV_PATH=/tmp/test.env python -c "
   from dotenv import load_dotenv
   load_dotenv('/tmp/test.env')
   from config import Config
   c = Config()
   c.log_startup()
   print('PASS: end-to-end config loading works')
   "
   rm /tmp/test.env
   ```
   Expected output includes masked API key (`****1234`) and all config values
4. `git check-ignore .env` confirms .env is gitignored
5. `git check-ignore .env.example` confirms .env.example is NOT gitignored (returns non-zero exit)
  </verify>
  <done>
.env.example exists with all SOLAREDGE_* variables documented in grouped sections. End-to-end flow works: load_dotenv() loads .env, Config() reads and validates, log_startup() masks secrets. .gitignore correctly excludes .env but allows .env.example.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase success criteria:

1. **CFG-01 (no hardcoded secrets)**: `config.py` loads ALL credentials from environment variables. The old hardcoded values in `se-overview.py` (api_key, site_id) have a replacement path -- later phases will import Config instead of using globals.
2. **CFG-02 (startup validation)**: Config() raises ValueError with ALL missing/invalid values listed at once. Test with no env vars set -- both SOLAREDGE_API_KEY and SOLAREDGE_SITE_ID appear in error.
3. **CFG-03 (.env.example)**: File exists with all 6 variables, descriptions, and grouped sections.
4. **CFG-04 (.gitignore)**: Already satisfied from Phase 1. Verify: `git check-ignore .env` returns 0.

Note: This phase creates the Config module. It does NOT modify se-overview.py to USE the Config module -- that wiring happens in Phase 3 (Architecture) when the monolith is split into modules.
</verification>

<success_criteria>
- config.py exists with Config dataclass (6 fields, validation, masking)
- Config() with no env vars raises ValueError listing both missing required fields
- Config() with valid env vars succeeds and all fields have correct values
- Boolean parsing: SOLAREDGE_DEBUG=false results in debug=False (not True)
- Integer parsing: invalid SOLAREDGE_POLL_INTERVAL produces clear error message
- log_startup() masks api_key (shows ****XXXX), shows other fields in full
- .env.example documents all 6 SOLAREDGE_* variables with descriptions
- requirements.txt contains python-dotenv==1.2.1
- .gitignore excludes .env but allows .env.example (pre-existing from Phase 1)
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-foundation/02-01-SUMMARY.md`
</output>
