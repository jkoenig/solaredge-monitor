---
phase: 06-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - solaredge-monitor.service
  - install.sh
  - deploy.sh
autonomous: true

must_haves:
  truths:
    - "systemd service file configures automatic startup and restart with correct venv path"
    - "install.sh automates full Pi provisioning (SPI, venv, deps, .env, systemd) idempotently"
    - "deploy.sh updates code and restarts service with verbose output"
  artifacts:
    - path: "solaredge-monitor.service"
      provides: "systemd unit file for automatic startup and restart"
      contains: "ExecStart=/home/pi/solaredge-monitor/venv/bin/python3 main.py"
    - path: "install.sh"
      provides: "Idempotent initial Pi setup script"
      contains: "raspi-config nonint do_spi 0"
    - path: "deploy.sh"
      provides: "Update and restart script"
      contains: "git pull"
  key_links:
    - from: "solaredge-monitor.service"
      to: "/home/pi/solaredge-monitor/venv/bin/python3"
      via: "ExecStart absolute path"
      pattern: "ExecStart=/home/pi/solaredge-monitor/venv/bin/python3 main.py"
    - from: "install.sh"
      to: "solaredge-monitor.service"
      via: "copies service file to /etc/systemd/system/"
      pattern: "sudo cp solaredge-monitor.service /etc/systemd/system/"
    - from: "deploy.sh"
      to: "solaredge-monitor"
      via: "systemctl restart"
      pattern: "sudo systemctl restart solaredge-monitor"
---

<objective>
Create systemd service file, install script, and deploy script for Raspberry Pi Zero WH deployment.

Purpose: Enable automated deployment and process management — the Pi starts the monitor on boot, restarts on failure, and updates via a single deploy.sh command.

Output: Three executable files in the repo root: solaredge-monitor.service, install.sh, deploy.sh.
</objective>

<execution_context>
@/Users/jean-pierrekoenig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jean-pierrekoenig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deployment/06-CONTEXT.md
@.planning/phases/06-deployment/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create systemd service file</name>
  <files>solaredge-monitor.service</files>
  <action>
Create `solaredge-monitor.service` in the repo root with these exact settings:

```ini
[Unit]
Description=SolarEdge Off-Grid Monitor
After=network.target

[Service]
Type=simple
User=pi
Group=pi
WorkingDirectory=/home/pi/solaredge-monitor
ExecStart=/home/pi/solaredge-monitor/venv/bin/python3 main.py
Restart=always
RestartSec=10
StartLimitIntervalSec=200
StartLimitBurst=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=solaredge-monitor

[Install]
WantedBy=multi-user.target
```

Key decisions already locked:
- `Restart=always` (restart on any exit, per user decision)
- `RestartSec=10` (per research recommendation)
- `StartLimitIntervalSec=200` / `StartLimitBurst=5` (per research, formula: 200 > 10*5=50)
- `User=pi` (has GPIO/SPI access by default)
- Absolute venv path in ExecStart (no venv activation)
- `SyslogIdentifier=solaredge-monitor` for clean journalctl filtering
- `StandardOutput=journal` + `StandardError=journal` (works with existing dual logging from Phase 5)
  </action>
  <verify>File exists at repo root. Contains [Unit], [Service], [Install] sections. ExecStart uses absolute venv path. Restart=always is set.</verify>
  <done>solaredge-monitor.service exists with correct systemd configuration for Pi deployment</done>
</task>

<task type="auto">
  <name>Task 2: Create install and deploy scripts</name>
  <files>install.sh, deploy.sh</files>
  <action>
Create `install.sh` in repo root — idempotent initial Pi setup script:

Requirements (from CONTEXT.md decisions):
- `set -e` and `set -u` for bash safety
- Check if running as root and refuse (must run as pi user)
- Check SPI: `ls /dev/spidev*` — if not found, enable with `sudo raspi-config nonint do_spi 0`, set REBOOT_REQUIRED flag
- Add user to spi/gpio groups (check first with `groups $USER | grep -q`)
- Create venv if `venv/` doesn't exist: `python3 -m venv venv`
- Install deps: `venv/bin/pip install --upgrade pip -q` then `venv/bin/pip install -r requirements.txt -q`
- Create .env from .env.example if .env doesn't exist (preserve existing .env)
- Copy solaredge-monitor.service to `/etc/systemd/system/`, run `daemon-reload`, `systemctl enable`
- Print numbered steps [1/6] through [6/6] for visibility
- Print next steps at end (different messages based on REBOOT_REQUIRED and NEEDS_ENV_CONFIG flags)

Create `deploy.sh` in repo root — update script run on Pi:

Requirements (from CONTEXT.md decisions):
- `set -e` for bash safety
- Check if running as root and refuse
- Step 1: `git pull`
- Step 2: `venv/bin/pip install -r requirements.txt -q`
- Step 3: `sudo systemctl restart solaredge-monitor`
- Print status after: `sudo systemctl status solaredge-monitor --no-pager -l`
- Verbose output: print each step as it happens

Both scripts:
- Start with `#!/bin/bash`
- Use `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` then `cd "$SCRIPT_DIR"` to ensure correct working directory
- Print a header banner with `=` separators
- Make executable after creation: `chmod +x install.sh deploy.sh`

Reference the research code examples closely — they have the exact patterns to follow.
  </action>
  <verify>Both files exist. Both are executable (`ls -la install.sh deploy.sh` shows `x` permission). Both start with `#!/bin/bash` and `set -e`. install.sh has `set -u`. install.sh checks for root user. deploy.sh checks for root user. install.sh contains `raspi-config nonint do_spi 0`. deploy.sh contains `git pull` and `systemctl restart`.</verify>
  <done>install.sh and deploy.sh exist, are executable, and contain all required deployment automation steps</done>
</task>

</tasks>

<verification>
1. `cat solaredge-monitor.service` shows valid systemd unit file with Restart=always, absolute venv path
2. `bash -n install.sh` — no syntax errors
3. `bash -n deploy.sh` — no syntax errors
4. `ls -la install.sh deploy.sh solaredge-monitor.service` — all exist, scripts executable
5. `grep -c 'set -e' install.sh deploy.sh` — both have error handling
6. `grep 'ExecStart' solaredge-monitor.service` — shows absolute venv path
</verification>

<success_criteria>
- solaredge-monitor.service has correct [Unit], [Service], [Install] sections with Restart=always, absolute venv path, RestartSec=10
- install.sh is idempotent (checks before creating venv, .env, SPI), refuses root, automates full setup
- deploy.sh pulls code, installs deps, restarts service with verbose output
- All three files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployment/06-01-SUMMARY.md`
</output>
