---
phase: 05-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - logging_setup.py
  - config.py
  - .env.example
  - requirements.txt
  - screens/error.py
autonomous: true

must_haves:
  truths:
    - "Structured JSON logging outputs to both stdout and rotating file"
    - "Log level is configurable via SOLAREDGE_LOG_LEVEL environment variable"
    - "Log files rotate at 10MB with 5 backups (60MB max)"
    - "Error screen renders 'API Unavailable' text on 1000x488 canvas"
  artifacts:
    - path: "logging_setup.py"
      provides: "setup_logging() function for JSON logging with rotation"
      exports: ["setup_logging"]
    - path: "config.py"
      provides: "Config with log_level field"
      contains: "log_level"
    - path: "screens/error.py"
      provides: "Error screen renderer"
      exports: ["render_error_screen"]
    - path: "requirements.txt"
      provides: "python-json-logger dependency"
      contains: "python-json-logger"
  key_links:
    - from: "logging_setup.py"
      to: "pythonjsonlogger"
      via: "JsonFormatter import"
      pattern: "from pythonjsonlogger"
    - from: "config.py"
      to: "SOLAREDGE_LOG_LEVEL"
      via: "os.environ.get"
      pattern: "SOLAREDGE_LOG_LEVEL"
---

<objective>
Set up the operational foundation that the main polling loop (Plan 02) depends on: structured JSON logging with rotation, log level configuration, and an error screen for API failure display.

Purpose: The main loop needs logging configured before it can log anything, and needs an error screen to display after 3 consecutive API failures. These are independent prerequisites.
Output: logging_setup.py, updated config.py, updated .env.example, updated requirements.txt, screens/error.py
</objective>

<execution_context>
@/Users/jean-pierrekoenig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jean-pierrekoenig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-operations/05-CONTEXT.md
@.planning/phases/05-operations/05-RESEARCH.md

@config.py
@requirements.txt
@.env.example
@screens/__init__.py
@rendering/fonts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logging setup and extend Config</name>
  <files>logging_setup.py, config.py, .env.example, requirements.txt</files>
  <action>
    1. Create `logging_setup.py` with a `setup_logging(log_level: str = "INFO", log_file: str = "solaredge_monitor.log")` function:
       - Use `pythonjsonlogger.json.JsonFormatter` with format `"%(asctime)s %(levelname)s %(name)s %(message)s"` and datefmt `"%Y-%m-%dT%H:%M:%S"`
       - Add `logging.StreamHandler()` for stdout (systemd captures this)
       - Add `RotatingFileHandler` with `maxBytes=10_000_000` (10MB), `backupCount=5`, `encoding='utf-8'`
       - Both handlers get the JSON formatter
       - Set root logger level from `log_level` parameter
       - Return the configured logger
       - Import: `from logging.handlers import RotatingFileHandler`, `from pythonjsonlogger.json import JsonFormatter`

    2. Extend `config.py`:
       - Add `log_level: str = "INFO"` field to Config dataclass (after debug field)
       - In `__post_init__`, load from `SOLAREDGE_LOG_LEVEL` env var, default "INFO"
       - Validate log_level is one of: DEBUG, INFO, WARNING, ERROR, CRITICAL (case-insensitive, store uppercase)
       - If invalid, add to errors list: `"  - SOLAREDGE_LOG_LEVEL: Must be one of DEBUG, INFO, WARNING, ERROR, CRITICAL (got '{value}')"`
       - Add `log_level` to `log_startup()` output

    3. Update `.env.example`:
       - Add `SOLAREDGE_LOG_LEVEL=INFO` with comment `# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL (default: INFO)` in the Operations section

    4. Update `requirements.txt`:
       - Add `python-json-logger>=3.0.0` (new dependency for structured logging)
       - Pin existing `requests>=2.31.0` as-is (already established pattern)
  </action>
  <verify>
    Run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "from logging_setup import setup_logging; logger = setup_logging('DEBUG'); import logging; logging.info('test', extra={'key': 'value'}); print('OK')"`
    Verify JSON output appears on stdout.
    Run: `python3 -c "import os; os.environ['SOLAREDGE_API_KEY']='test'; os.environ['SOLAREDGE_SITE_ID']='123'; os.environ['SOLAREDGE_LOG_LEVEL']='DEBUG'; from config import Config; c = Config(); print(c.log_level)"`
    Should print: DEBUG
  </verify>
  <done>
    - logging_setup.py exists with setup_logging() that configures JSON stdout + rotating file handlers
    - Config has log_level field loaded from SOLAREDGE_LOG_LEVEL, validated against allowed levels
    - .env.example documents SOLAREDGE_LOG_LEVEL
    - requirements.txt includes python-json-logger>=3.0.0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create error screen renderer</name>
  <files>screens/error.py</files>
  <action>
    Create `screens/error.py` with a `render_error_screen(message: str = "API nicht erreichbar") -> Image` function:
    - Create 1000x488 mode '1' image with white background (value 1)
    - Use the same MARGIN=15 and canvas conventions as other screens
    - Draw headline "Fehler" at top-left (MARGIN, MARGIN) using Arial 48 via `rendering.fonts.load_font`
    - Center the error message text both horizontally and vertically in the remaining canvas area (below headline)
    - Use Arial 36 for the error message
    - Keep it simple: just headline + centered message text, no icons or bars
    - Do NOT modify `screens/__init__.py` -- the error screen is NOT part of the normal cycling; it will be called directly by main.py when needed
  </action>
  <verify>
    Run: `cd /Users/jean-pierrekoenig/Documents/Projects/solaredge-offgrid-monitor && python3 -c "from screens.error import render_error_screen; img = render_error_screen(); print(f'{img.size} {img.mode}')"`
    Should print: (1000, 488) 1
  </verify>
  <done>
    - screens/error.py exists with render_error_screen() that returns a 1000x488 mode '1' PIL Image
    - Error screen shows "Fehler" headline and centered error message
    - Function is importable and callable without other dependencies beyond rendering utilities
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "from logging_setup import setup_logging; setup_logging('INFO')"` -- no import errors
2. `python3 -c "from screens.error import render_error_screen; img = render_error_screen(); assert img.size == (1000, 488) and img.mode == '1'"` -- error screen works
3. `grep 'python-json-logger' requirements.txt` -- dependency present
4. `grep 'SOLAREDGE_LOG_LEVEL' .env.example` -- env var documented
5. `grep 'log_level' config.py` -- field exists in Config
</verification>

<success_criteria>
- Structured JSON logging configurable by log level, outputs to stdout and rotating file
- Config extended with validated log_level field
- Error screen renders simple "Fehler" / "API nicht erreichbar" on standard canvas
- All new dependencies declared in requirements.txt
</success_criteria>

<output>
After completion, create `.planning/phases/05-operations/05-01-SUMMARY.md`
</output>
